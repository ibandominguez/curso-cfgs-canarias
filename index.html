<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Curso Prueba CFGS Canarias</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="favicon.ico" />
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      /* Estilo para transici√≥n del sidebar */
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div x-data="studyApp()" x-init="init()" class="flex flex-col h-screen">
      <header
        class="bg-white shadow-md p-4 flex justify-between items-center z-10"
      >
        <button
          @click="isSidebarOpen = !isSidebarOpen; stopSpeech()"
          class="lg:hidden text-gray-600 focus:outline-none"
          :class="{'hidden': !subjectData}"
        >
          <svg
            x-show="!isSidebarOpen"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
          <svg
            x-show="isSidebarOpen"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>

        <h1 class="text-xl lg:text-2xl font-bold text-gray-800">
          <a href="/curso-cfgs-canarias/">
            üìö <span class="hidden sm:inline">Repaso Prueba CFGS</span>
          </a>
        </h1>

        <div class="flex items-center space-x-4">
          <label
            for="subject-select"
            class="text-gray-600 font-medium hidden sm:block"
            >Asignatura:</label
          >
          <select
            id="subject-select"
            x-model="selectedSubject"
            @change="loadSubject(selectedSubject, true)"
            class="p-2 text-sm lg:text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="" disabled>Selecciona...</option>
            <template x-for="subject in availableSubjects" :key="subject.file">
              <option :value="subject.file" x-text="subject.name"></option>
            </template>
          </select>
        </div>
      </header>

      <main class="flex flex-1 relative">
        <!-- Vista de selecci√≥n de asignatura -->
        <div x-show="!subjectData" x-cloak class="w-full p-4 sm:p-6 md:p-8">
          <h2
            class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center"
          >
            Selecciona una asignatura
          </h2>
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"
          >
            <template x-for="subject in availableSubjects" :key="subject.file">
              <button
                @click="loadSubject(subject.file, true)"
                class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 ease-in-out flex flex-col items-center text-center border-2 border-transparent hover:border-blue-500"
              >
                <span
                  class="text-4xl mb-3"
                  x-text="subject.emoji || 'üìö'"
                ></span>
                <h3
                  class="text-lg font-semibold text-gray-900"
                  x-text="subject.name"
                ></h3>
              </button>
            </template>
          </div>
        </div>

        <!-- Vista de contenido de la asignatura -->
        <template x-if="subjectData">
          <div class="flex flex-1 overflow-hidden">
            <nav
              x-cloak
              :class="{ 
                        'translate-x-0': isSidebarOpen, 
                        '-translate-x-full': !isSidebarOpen 
                    }"
              class="w-64 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4 flex-shrink-0 lg:translate-x-0 lg:static absolute inset-y-0 left-0 z-20 sidebar-transition"
            >
              <h2
                class="text-xl font-semibold mb-4 text-gray-700"
                x-text="subjectData ? subjectData.title : ''"
              ></h2>

              <template
                x-for="([topic, contents], topicIndex) in $store.groupedContents"
                :key="topic"
              >
                <div
                  :class="{'mt-4 border-t pt-4 border-gray-300': topicIndex > 0}"
                >
                  <h3
                    class="font-bold text-base text-gray-800 mb-2"
                    x-text="topic"
                  ></h3>
                  <template
                    x-for="(content, index) in contents"
                    :key="content.title"
                  >
                    <div class="mb-2">
                      <button
                        :id="`sidebar-content-${content.originalIndex}`"
                        @click="selectContent(content.originalIndex); isSidebarOpen = false"
                        :class="{ 
                                            'bg-blue-500 text-white font-semibold': selectedContentIndex === content.originalIndex, 
                                            'text-gray-700 hover:bg-blue-100': selectedContentIndex !== content.originalIndex 
                                        }"
                        class="w-full text-left p-2 pl-4 rounded-lg transition duration-150 ease-in-out text-sm"
                      >
                        <span x-text="content.title"></span>
                      </button>
                    </div>
                  </template>
                </div>
              </template>
            </nav>

            <div
              x-show="isSidebarOpen"
              @click="isSidebarOpen = false"
              class="lg:hidden absolute inset-0 bg-black opacity-50 z-10"
            ></div>

            <div id="content" class="flex-1 overflow-y-auto p-4 lg:p-8">
              <template x-if="selectedContent">
                <div>
                  <h2
                    class="text-2xl lg:text-3xl font-extrabold mb-2 text-gray-800"
                    x-text="selectedContent.title"
                  ></h2>
                  <p
                    class="text-sm text-blue-600 font-medium mb-6"
                    x-text="selectedContent.topic"
                  ></p>

                  <button
                    @click="isSpeaking ? stopSpeech() : speak(selectedContent.text)"
                    :class="{
                      'bg-red-500 hover:bg-red-600': isSpeaking,
                      'bg-green-500 hover:bg-green-600': !isSpeaking
                    }"
                    class="text-white font-bold py-2 px-4 rounded flex items-center transition duration-150 mb-6"
                  >
                    <svg
                      x-show="!isSpeaking"
                      class="w-5 h-5 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9c2.828 2.83 2.828 7.425 0 10.253M17 13h1m-1 3h1m-1-7h1m-1 3h-1m-4 3h1m-1 3h1m-1-7h1m-1 3h-1m-4 3h1m-1 3h1m-1-7h1m-1 3h-1m-4 3h1m-1 3h1m-1-7h1"
                      ></path>
                    </svg>
                    <svg
                      x-show="isSpeaking"
                      class="w-5 h-5 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 10h6m-3 3v-6"
                      ></path>
                    </svg>
                    <span
                      x-text="isSpeaking ? 'Detener Lectura' : 'Escuchar Lectura'"
                    ></span>
                  </button>

                  <div
                    class="prose lg:prose-lg max-w-none mb-10 p-6 bg-white rounded-xl shadow-lg border border-gray-200"
                    x-html="renderMarkdown(selectedContent.text)"
                  ></div>

                  <h3
                    class="text-xl lg:text-2xl font-bold text-gray-700 mb-4 border-b pb-2"
                  >
                    Secci√≥n de Repaso R√°pido
                  </h3>

                  <template
                    x-for="(question, qIndex) in selectedContent.questions"
                    :key="qIndex"
                  >
                    <div
                      class="mb-6 p-5 bg-white rounded-lg shadow-sm border border-blue-100"
                    >
                      <p
                        class="font-semibold text-base lg:text-lg text-gray-800 mb-3"
                        x-text="`${qIndex + 1}. ${question.text}`"
                      ></p>

                      <div class="space-y-2">
                        <template
                          x-for="(option, oIndex) in question.options"
                          :key="oIndex"
                        >
                          <button
                            @click="checkAnswer(qIndex, oIndex, option.correct)"
                            :disabled="answers[selectedContentIndex] && answers[selectedContentIndex][qIndex] !== undefined"
                            :class="getOptionClasses(qIndex, oIndex, option.correct)"
                          >
                            <span x-text="option.text"></span>
                            <span
                              x-show="answers[selectedContentIndex] && answers[selectedContentIndex][qIndex] !== undefined && option.correct"
                              class="float-right text-green-700 font-bold"
                            >
                              ‚úî Correcto
                            </span>
                            <span
                              x-show="answers[selectedContentIndex] && answers[selectedContentIndex][qIndex] === oIndex && !option.correct"
                              class="float-right text-red-700 font-bold"
                            >
                              ‚ùå Incorrecto
                            </span>
                          </button>
                        </template>
                      </div>
                    </div>
                  </template>

                  <template x-if="selectedContent.appUrl">
                    <div
                      class="mb-10 p-4 bg-white rounded-xl shadow-lg border border-blue-200"
                      :class="{ 'hidden sm:block': selectedContent.appUrl.includes('desktop') }"
                    >
                      <h3
                        class="text-xl font-bold text-gray-700 mb-4 border-b pb-2"
                      >
                        üß© Ejercicio Interactivo
                      </h3>
                      <iframe
                        :src="selectedContent.appUrl"
                        frameborder="0"
                        class="w-full rounded-lg"
                        style="height: 120vh; min-height: 600px"
                      ></iframe>
                    </div>
                  </template>

                  <div class="flex justify-between mt-12 border-t pt-8">
                    <!-- Bot√≥n Anterior -->
                    <div class="w-1/2 pr-2">
                      <template x-if="selectedContentIndex > 0">
                        <button
                          @click="selectContent(selectedContentIndex - 1)"
                          class="w-full text-left p-4 rounded-lg bg-white hover:bg-gray-50 shadow-md transition-all duration-200 hover:shadow-xl border border-gray-200 overflow-hidden"
                        >
                          <div class="flex items-center">
                            <svg
                              class="w-8 h-8 mr-4 text-blue-500 flex-shrink-0"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"
                              ></path>
                            </svg>
                            <div>
                              <p class="text-sm font-semibold text-gray-500">
                                Anterior
                              </p>
                              <p
                                class="text-base lg:text-lg font-bold text-gray-800 truncate"
                                x-text="subjectData.contents[selectedContentIndex - 1].title"
                              ></p>
                            </div>
                          </div>
                        </button>
                      </template>
                    </div>

                    <!-- Bot√≥n Siguiente -->
                    <div class="w-1/2 pl-2">
                      <template
                        x-if="selectedContentIndex < subjectData.contents.length - 1"
                      >
                        <button
                          @click="selectContent(selectedContentIndex + 1)"
                          class="w-full text-right p-4 rounded-lg bg-white hover:bg-gray-50 shadow-md transition-all duration-200 hover:shadow-xl border border-gray-200 overflow-hidden"
                        >
                          <div class="flex items-center justify-end">
                            <div class="text-right">
                              <p class="text-sm font-semibold text-gray-500">
                                Siguiente
                              </p>
                              <p
                                class="text-base lg:text-lg font-bold text-gray-800 truncate"
                                x-text="subjectData.contents[selectedContentIndex + 1].title"
                              ></p>
                            </div>
                            <svg
                              class="w-8 h-8 ml-4 text-blue-500 flex-shrink-0"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M14 5l7 7m0 0l-7 7m7-7H3"
                              ></path>
                            </svg>
                          </div>
                        </button>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </main>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        // 1. Store para agrupar los contenidos
        Alpine.store("groupedContents", {});

        Alpine.data("studyApp", () => ({
          availableSubjects: [
            { name: "Filosof√≠a", file: "subjects/filosofia.json", emoji: "ü§î" },
            {
              name: "Empresa y modelos negocios",
              file: "subjects/empresa.json",
              emoji: "üíº",
            },
            {
              name: "Lengua y literatura",
              file: "subjects/lengua.json",
              emoji: "üìñ",
            },
            {
              name: "Matem√°ticas",
              file: "subjects/matematicas.json",
              emoji: "‚ûó",
            },
          ],
          selectedSubject: "",
          subjectData: null,
          selectedContentIndex: null,
          answers: {},
          isSpeaking: false,
          isSidebarOpen: false,

          get selectedContent() {
            return (
              this.subjectData?.contents[this.selectedContentIndex] || null
            );
          },

          init() {
            setTimeout(() => this.route(), 50);
            window.addEventListener("hashchange", () => this.route());

            if (window.innerWidth >= 1024) {
              this.isSidebarOpen = true;
            }
          },

          route() {
            const hash = window.location.hash.substring(2); // from #/subject/index
            const [subjectSlug, contentIndexStr] = hash.split("/");

            const subjectToLoad = this.availableSubjects.find(
              (s) =>
                s.file.split("/").pop().replace(".json", "") === subjectSlug,
            );

            if (subjectToLoad) {
              const urlContentIndex = contentIndexStr
                ? parseInt(contentIndexStr, 10)
                : null;

              if (subjectToLoad.file !== this.selectedSubject) {
                this.selectedSubject = subjectToLoad.file;
                this.loadSubject(this.selectedSubject, true, urlContentIndex);
              } else if (
                urlContentIndex !== null &&
                urlContentIndex !== this.selectedContentIndex
              ) {
                this.selectContent(urlContentIndex);
              }
            } else {
              // Si no hay hash, o no es v√°lido, nos aseguramos de que no haya ninguna asignatura cargada
              // para que se muestre la pantalla de selecci√≥n.
              this.subjectData = null;
              this.selectedSubject = "";
              // Limpiamos el hash si es inv√°lido para tener una URL limpia
              if (window.location.hash) {
                history.pushState(
                  "",
                  document.title,
                  window.location.pathname + window.location.search,
                );
              }
            }
          },

          updateUrl(subjectFile, contentIndex) {
            if (!subjectFile) return;
            const subjectSlug = subjectFile
              .split("/")
              .pop()
              .replace(".json", "");
            const newHash = `#/${subjectSlug}/${contentIndex}`;
            if (window.location.hash !== newHash) {
              // Usamos replaceState para evitar a√±adir al historial cada vez que cambiamos de secci√≥n
              history.replaceState(null, null, newHash);
            }
          },

          getBookmark(subjectFile) {
            if (!subjectFile) return null;
            const bookmarks =
              JSON.parse(localStorage.getItem("subjectBookmarks")) || {};
            return bookmarks[subjectFile] !== undefined
              ? bookmarks[subjectFile]
              : null;
          },

          setBookmark(subjectFile, contentIndex) {
            if (!subjectFile) return;
            const bookmarks =
              JSON.parse(localStorage.getItem("subjectBookmarks")) || {};
            bookmarks[subjectFile] = contentIndex;
            localStorage.setItem("subjectBookmarks", JSON.stringify(bookmarks));
          },

          getOptionClasses(qIndex, oIndex, isCorrectOption) {
            const contentIndex = this.selectedContentIndex;
            const answersForContent = this.answers[contentIndex];

            const isAnswered =
              answersForContent && answersForContent[qIndex] !== undefined;
            const userSelectionIndex = isAnswered
              ? answersForContent[qIndex]
              : null;
            const userSelectedThis = userSelectionIndex === oIndex;

            let classes =
              "w-full text-left p-3 rounded-md border-2 transition duration-200 text-sm";

            if (!isAnswered) {
              classes +=
                " border-gray-200 bg-gray-50 hover:bg-gray-100 cursor-pointer";
            } else {
              if (isCorrectOption) {
                classes += " bg-green-100 border-green-500 font-medium";
              } else if (userSelectedThis) {
                classes += " bg-red-100 border-red-500 font-medium";
              } else {
                classes +=
                  " bg-gray-100 border-gray-200 text-gray-500 cursor-not-allowed";
              }
            }

            return classes;
          },

          groupContents(contents) {
            const grouped = {};
            contents.forEach((content, index) => {
              const contentWithIndex = { ...content, originalIndex: index };
              const topic = content.topic || "Sin tema";
              if (!grouped[topic]) {
                grouped[topic] = [];
              }
              grouped[topic].push(contentWithIndex);
            });
            return Object.entries(grouped);
          },

          async loadSubject(
            file,
            resetAnswers = true,
            requestedContentIndex = null,
          ) {
            this.stopSpeech();
            // No establecemos subjectData a null aqu√≠ para evitar parpadeos.
            // Se actualizar√° directamente cuando los datos est√©n listos.

            if (resetAnswers) {
              this.answers = {};
            }

            try {
              const response = await fetch(file);
              if (!response.ok) {
                throw new Error(
                  `No se pudo cargar ${file}. Aseg√∫rate de que el archivo JSON existe.`,
                );
              }
              const data = await response.json();
              this.subjectData = data;
              this.selectedSubject = file; // Asegurarse de que el select est√° sincronizado

              Alpine.store(
                "groupedContents",
                this.groupContents(this.subjectData.contents),
              );

              if (this.subjectData.contents.length > 0) {
                const bookmarkedIndex = this.getBookmark(file);
                const indexToLoad =
                  requestedContentIndex !== null
                    ? requestedContentIndex
                    : bookmarkedIndex !== null
                      ? bookmarkedIndex
                      : 0;

                this.selectContent(indexToLoad, true); // Pasamos true para indicar que es una carga inicial
              }
            } catch (error) {
              console.error("Error al cargar la asignatura:", error);
              this.subjectData = { title: "Error de Carga", contents: [] };
            }
          },

          selectContent(index, isInitialLoad = false) {
            this.stopSpeech();
            this.selectedContentIndex = index;

            // Solo actualizamos la URL. Si es una carga inicial, la URL ya ha sido manejada por route().
            this.updateUrl(this.selectedSubject, index);
            this.setBookmark(this.selectedSubject, index);

            if (!this.answers[index]) {
              this.answers[index] = {};
              this.answers = { ...this.answers };
            }

            document.getElementById("content")?.scrollTo({ top: 0 });

            this.$nextTick(() => {
              const activeButton = this.$root.querySelector(
                `#sidebar-content-${index}`,
              );
              if (activeButton) {
                activeButton.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
            });
          },

          checkAnswer(qIndex, oIndex, isCorrect) {
            if (
              this.answers[this.selectedContentIndex] &&
              this.answers[this.selectedContentIndex][qIndex] === undefined
            ) {
              this.answers[this.selectedContentIndex][qIndex] = oIndex;
              this.answers = { ...this.answers };
            }
          },

          renderMarkdown(markdownText) {
            if (!markdownText || !window.marked) return "";
            markdownText = markdownText.replace(
              /\b([A-Za-z])_([a-zA-Z0-9\-]+)\b/g,
              "$1<sub>$2</sub>",
            );
            markdownText = markdownText.replace(
              /\b([A-Za-z0-9<>\(\)]+)\^2\b/g,
              "$1&sup2;",
            );
            markdownText = markdownText.replace(/\\bar\{x\}/g, "x&#773;");
            markdownText = markdownText.replace(/\\sigma\^2/g, "&sigma;&sup2;");
            markdownText = markdownText.replace(/\\sigma/g, "&sigma;");
            markdownText = markdownText.replace(
              /\\sum_{([^}]+)}/g,
              "&#8721;<sub>$1</sub>",
            );
            markdownText = markdownText.replace(
              /‚àëi=1\^\{n\}/g,
              "&#8721;<sub>i=1</sub>^n",
            );
            markdownText = markdownText.replace(/\\cdot|‚ãÖ/g, "&#8901;");
            markdownText = markdownText.replace(
              /\\frac\{([^}]+)\}\{([^}]+)\}/g,
              "($1) / ($2)",
            );
            markdownText = markdownText.replace(
              /\[iframe:(https?:\/\/[^\]]+)\]/g,
              '<div class="relative w-full aspect-video rounded overflow-hidden shadow-sm my-5"><iframe class="absolute inset-0 w-full h-full" src="$1" title="T√≠tulo accesible del v√≠deo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe></div>',
            );
            markdownText = markdownText.replace(/\\sqrt\{([^}]+)\}/g, "‚àö($1)");
            markdownText = markdownText.replace(/M_o/g, "M<sub>o</sub>");
            markdownText = markdownText.replace(/\$\$?/g, "");
            return marked.parse(markdownText);
          },

          cleanMarkdownForSpeech(markdownText) {
            if (!markdownText) return "";
            let cleanText = markdownText.replace(/(\*\*|__|\*|_|#|`|>)/g, "");
            cleanText = cleanText.replace(/(\r\n|\n|\r)/gm, ". ");
            cleanText = cleanText.replace(/\s{2,}/g, " ");
            return cleanText;
          },

          speak(text) {
            this.stopSpeech();

            if ("speechSynthesis" in window) {
              const cleanText = this.cleanMarkdownForSpeech(text);
              const utterance = new SpeechSynthesisUtterance(cleanText);
              utterance.lang = "es-ES";

              utterance.onstart = () => {
                this.isSpeaking = true;
              };
              utterance.onend = () => {
                this.isSpeaking = false;
              };
              utterance.onerror = () => {
                this.isSpeaking = false;
                console.error("Error en la lectura de voz");
              };

              window.speechSynthesis.speak(utterance);
            } else {
              alert("Tu navegador no soporta la API de Speech Synthesis.");
              this.isSpeaking = false;
            }
          },

          stopSpeech() {
            if (
              "speechSynthesis" in window &&
              window.speechSynthesis.speaking
            ) {
              window.speechSynthesis.cancel();
              this.isSpeaking = false;
            }
          },
        }));
      });
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((registration) => {
              console.log(
                "Service Worker registrado con √©xito:",
                registration.scope,
              );
            })
            .catch((error) => {
              console.log("Fallo al registrar el Service Worker:", error);
            });
        });
      }
    </script>
  </body>
</html>
